<template>
  <div class="wrapper">

    <Sidebar />
    <div class="main">
      <Navbar />

      <main class="content">
        <div class="container-fluid p-0">

          <div v-if="mostrarSkeleton" class="skeleton-title-dashboard"></div>
          <h1 v-if="!mostrarSkeleton" class="h3 mb-3"><strong>Dashboard |</strong> Construtora</h1>

          <div class="col-xl-12 mt-2" v-if="progressView">
            <div class="w-100">
              <div class="row">
                <div class="row" style="margin-left: 2%; margin-top: 2%; margin-bottom: 3%;">
                  <div class="col-xl-2">
                    <div v-if="mostrarSkeleton" class="skeleton-card"></div>
                    <div class="card" v-if="!mostrarSkeleton">
                      <div class="card-body">
                        <div class="row">
                          <h6 class="text-center"><small>Perfil</small></h6>
                          <img class="iconProgress" src="../../../assets/images/icons/iconPerfil.png" alt="">
                          <div v-if="perfil === 0">
                            <img class="mt-3 iconCheck img-fluid"
                              src="../../../assets/images/icons/iconCheckInActive.png" alt="">
                          </div>
                          <div v-if="perfil === 1">
                            <img class="mt-3 iconCheck img-fluid" src="../../../assets/images/icons/iconCheckActive.png"
                              alt="">
                          </div>

                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-xl-1 mt-5">
                    <hr class="linhacomplete">
                  </div>

                  <div class="col-xl-2">
                    <div v-if="mostrarSkeleton" class="skeleton-card"></div>
                    <div class="card" v-if="!mostrarSkeleton">
                      <div class="card-body">
                        <div class="row">
                          <h6 class="text-center"><small>Qualidade 9/10</small></h6>
                          <img class="iconProgress" src="../../../assets/images/icons/iconStar.png" alt="">
                          <div v-if="capa === 0">
                            <img class="mt-3 iconCheck img-fluid"
                              src="../../../assets/images/icons/iconCheckInActive.png" alt="">
                          </div>
                          <div v-if="capa === 1">
                            <img class="mt-3 iconCheck img-fluid" src="../../../assets/images/icons/iconCheckActive.png"
                              alt="">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-xl-1 mt-5">
                    <hr class="linhacomplete">
                  </div>
                  <div class="col-xl-2">
                    <div v-if="mostrarSkeleton" class="skeleton-card"></div>
                    <div class="card" v-if="!mostrarSkeleton">
                      <div class="card-body">
                        <div class="row">
                          <h6 class="text-center"><small>Im√≥vel</small> </h6>
                          <img class="iconProgress" src="../../../assets/images/icons/iconImovel.png" alt="">

                          <div v-if="imovel === 0">
                            <img class="mt-3 iconCheck img-fluid"
                              src="../../../assets/images/icons/iconCheckInActive.png" alt="">
                          </div>
                          <div v-if="imovel === 1">
                            <img class="mt-3 iconCheck img-fluid" src="../../../assets/images/icons/iconCheckActive.png"
                              alt="">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-xl-1 mt-5">
                    <hr class="linhacomplete">
                  </div>
                  <div class="col-xl-2">
                    <div v-if="mostrarSkeleton" class="skeleton-card"></div>
                    <div class="card" v-if="!mostrarSkeleton">
                      <div class="card-body">
                        <div class="row">
                          <h6 class="text-center"><small>Publica√ß√£o</small> </h6>
                          <img class="iconProgress" src="../../../assets/images/icons/iconPublish.png" alt="">
                          <div v-if="publicacao === 0">
                            <img class="mt-3 iconCheck img-fluid"
                              src="../../../assets/images/icons/iconCheckInActive.png" alt="">
                          </div>
                          <div v-if="publicacao === 1">
                            <img class="mt-3 iconCheck img-fluid" src="../../../assets/images/icons/iconCheckActive.png"
                              alt="">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xl-12 mt-5">
            <div class="w-100">
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <div class="row">
                        <div class="col mt-0">
                          <h5 class="card-title">Imoveis cadastrados</h5>
                        </div>
                        <div class="col-auto">
                          <div class="stat text-primary">
                            <i class="align-middle" data-feather="home"></i>
                          </div>
                        </div>
                      </div>
                      <h1 class="mt-1 mb-3">{{ totalImovel }}</h1>
                      <div class="mb-0">
                        <span class="text-danger">
                          <i class="mdi mdi-arrow-bottom-right"></i>
                        </span>
                        <span class="text-muted">Estimativa Geral</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <div class="row">
                        <div class="col mt-0">
                          <h5 class="card-title">Condom√≠nios cadastrados</h5>
                        </div>
                        <div class="col-auto">
                          <div class="stat text-primary">
                            <i class="align-middle" data-feather="grid"></i>
                          </div>
                        </div>
                      </div>
                      <h1 class="mt-1 mb-3">{{ totalCondominios }}</h1>
                      <div class="mb-0">
                        <span class="text-danger">
                          <i class="mdi mdi-arrow-bottom-right"></i>
                        </span>
                        <span class="text-muted">Estimativa Geral</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
          </div>
          <div class="col-xl-12 mt-5">
            <div class="w-100">
              <div class="row">
                <div class="col-xl-5 col-xxl-5">
                  <div class="card flex-fill w-100">
                    <div class="card-header">
                      <h5 class="card-title mb-0"><i class="fa fa-clock"></i> Seus ultimos im√≥veis
                        cadastrados</h5>
                    </div>
                    <div class="card-body py-3">
                      <input type="text" placeholder="Pesquise aqui" class="form-control mb-3"
                        aria-describedby="passwordHelpBlock" v-model="searchImovel" />
                      <div class="mt-5" v-for="item in imoveisOnCurrentPage" :key="item.id_imovel">

                        <a class="row" style="text-decoration: none;">
                          <div class="col-3">
                            <img class="thumbImovel" :src="`https://zonu.com.br/api${item.fotos[0].foto}`" alt="">
                          </div>

                          <div class="col-9" style="margin-left: -10px;">
                            <h5><i class="fa fa-building"></i> <a href="#" style="text-decoration: none; color: #000;"
                                data-bs-toggle="modal" :data-bs-target="`#modalImovel${item.id_imovel}`"><strong>{{
                                  item.descricao.titulo }}</strong></a> <span class="badge text-bg-success">{{
                                    item.preco.tipo_negocio }}</span><a data-bs-toggle="modal"
                                :data-bs-target="`#exampleModal${item.id_imovel}`" style="float: inline-end;"
                                class="text-danger"><i class="fa fa-trash"></i></a>
                            </h5>
                            <h5 class="text-info"><strong>{{ formatCurrency(item.preco.preco_imovel) }}</strong><a
                                data-bs-toggle="modal" :data-bs-target="`#modalImovel${item.id_imovel}`"
                                style="float: inline-end;" class="text-info"><i class="fa fa-eye"></i></a></h5>
                            <h5 class="text-dark"><small><i class="fa fa-map-marker "></i>
                                {{ item.localizacao.logradouro }}, {{ item.localizacao.numero }} | {{
                                  item.localizacao.bairro }}, {{ item.localizacao.cidade }}</small> <a
                                data-bs-toggle="modal" :data-bs-target="`#modalEditImovel${item.id_imovel}`"
                                style="float: inline-end;" class="text-warning"><i class="fa fa-edit"></i></a></h5>
                            <h5 class="text-dark"><small><i class="fa fa-calendar "></i>
                                Atualizado: {{ formatarData(item.updatedAt) }}</small> <i v-for="star in estrelas"
                                :key="star" class="text-warning fa fa-star"></i> <span class="text-success"
                                style="float: inline-end; font-weight: 900;">
                                {{ qualidade }}</span></h5>
                          </div>
                        </a>

                        <div class="modal fade" :id="`exampleModal${item.id_imovel}`" tabindex="-1"
                          aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="fa fa-trash"></i> Apagar
                                  im√≥vel</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                  aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <h3 class="text-center">Voc√™ tem certeza que deseja apagar este im√≥vel?</h3>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button @click="handledDelete(item.id_imovel)" type="button" class="btn btn-success"><i
                                    class="fa fa-trash"></i> Sim, apagar</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <hr class="mt-3">
                        <!-- Modal -->
                        <div class="modal fade" :id="`modalImovel${item.id_imovel}`" tabindex="-1"
                          aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="fa fa-building"></i> {{
                                  item.descricao.titulo }}
                                </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                  aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <nav>
                                  <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                    <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab"
                                      data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home"
                                      aria-selected="true"><i class="fa fa-bell" aria-hidden="true"></i>

                                      Informa√ß√µes do im√≥vel </button>

                                    <button class="nav-link" id="nav-comentario-tab" data-bs-toggle="tab"
                                      data-bs-target="#nav-comentario" type="button" role="tab"
                                      aria-controls="nav-comentario" aria-selected="false">Anota√ß√µes <small><i
                                          class="fa fa-file"></i></small></button>

                                    <button class="nav-link" id="nav-documentos-tab" data-bs-toggle="tab"
                                      data-bs-target="#nav-documentos" type="button" role="tab"
                                      aria-controls="nav-documentos" aria-selected="false">Documentos <small><i
                                          class="fa fa-folder"></i></small></button>

                                  </div>
                                </nav>
                                <div class="tab-content" id="nav-tabContent">
                                  <div class="tab-pane fade show active" id="nav-home" role="tabpanel"
                                    aria-labelledby="nav-home-tab" tabindex="0">
                                    <div class="container">
                                      <div class="row">
                                        <div class="col-md-2 mt-4" v-for="foto in item.fotos" :key="foto.id_imagem">
                                          <img :src="`https://zonu.com.br/api${foto.foto}`"
                                            :alt="`Foto ${foto.id_imagem} do Im√≥vel ${item.id_imovel}`"
                                            class="thumbnail-modal">
                                        </div>
                                      </div>

                                      <div class="row mt-4">
                                        <div class="col-md-2">
                                          <h5><strong><i class="fa fa-money" aria-hidden="true"></i> Pre√ßo <small
                                                style="font-size: 10px;" class="text-secondary">({{
                                                  item.preco.tipo_negocio }})</small></strong>
                                          </h5>
                                          <h4 class="text-success"><strong>{{ item.preco.preco_imovel }} </strong>
                                          </h4>
                                        </div>
                                        <div class="col-md-2">
                                          <h5><strong><i class="fa fa-money" aria-hidden="true"></i> Condom√≠nio</strong>
                                          </h5>
                                          <h4 class="text-success"><strong>{{ item.preco.preco_condominio }}</strong>
                                          </h4>
                                        </div>
                                        <div class="col-md-2">
                                          <h5><strong><i class="fa fa-tag" aria-hidden="true"></i>
                                              Taxas <small style="font-size: 10px;"
                                                class="text-secondary">(Mensal)</small></strong>
                                          </h5>
                                          <h4 class="text-success"><strong>{{ item.preco.total_mensal_taxas }}</strong>
                                          </h4>
                                        </div>
                                        <hr class="mt-3">
                                      </div>

                                      <div class="row mt-3">
                                        <div class="col-md-8">
                                          <h6 style="font-size: 12px;"><strong><i class="fa fa-building-o"
                                                aria-hidden="true"></i>
                                              C√¥modos</strong>
                                          </h6>
                                          <div class="row mt-3 ml-2">
                                            <div class="col-md-3">
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Dormit√≥rios: {{ item.comodos.dormitorio }}</strong>
                                              </h6>
                                              <h6 v-if="item.comodos.suite !== 0"
                                                style="font-size: 12px; text-align: right;">
                                                <strong>Sendo Suites: {{ item.comodos.suite }}</strong>
                                              </h6>
                                              <h6 v-if="item.comodos.suite == 0"
                                                style="font-size: 12px; text-align: right;">
                                                <strong>Sendo Suites: N√£o</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Banheiros: {{ item.comodos.banheiro }}</strong>
                                              </h6>
                                              <h6 v-if="item.comodos.garagem == 0"
                                                style="font-size: 12px; text-align: right;">
                                                <strong>Garagens: N√£o</strong>
                                              </h6>
                                              <h6 v-if="item.comodos.garagem !== 0"
                                                style="font-size: 12px; text-align: right;">
                                                <strong>Garagens: {{ item.comodos.garagem }}</strong>
                                              </h6>
                                            </div>
                                            <div class="col-md-3">
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>√Årea de Servi√ßo: {{ item.comodos.area_servico }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Banheiros: {{ item.comodos.banheiro }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Dep. empregada: {{ item.comodos.casa_empregada }}</strong>
                                              </h6>

                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Box Garagem: {{ item.comodos.garagem_box }}</strong>
                                              </h6>
                                            </div>
                                            <div class="col-md-2">
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Copa: {{ item.comodos.copa }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Cozinha: {{ item.comodos.cozinha }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Escrit√≥rio: {{ item.comodos.escritorio }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Garagem coberta: {{ item.comodos.garagem_coberta }}</strong>
                                              </h6>

                                            </div>
                                            <div class="col-md-2">
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Closet: {{ item.comodos.closet }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Lavabo: {{ item.comodos.lavabo }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Sl de estar: {{ item.comodos.sala_estar }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Sl de jantar: {{ item.comodos.sala_jantar }}</strong>
                                              </h6>
                                            </div>

                                            <div class="col-md-2">
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Sala de TV: {{ item.comodos.sala_tv }}</strong>
                                              </h6>
                                              <h6 style="font-size: 12px; text-align: right;">
                                                <strong>Dormit√≥rios com suites: {{ item.comodos.suite }}</strong>
                                              </h6>
                                            </div>
                                          </div>

                                        </div>
                                        <div class="col-md-1 mt-3">
                                          <div style="border-left: 1px solid #0001; height: 100px; ">
                                          </div>
                                        </div>
                                        <div class="col-md-2">
                                          <h6 style="font-size: 12px; margin-left: -70px; ">
                                            <strong><i class="fa fa-ruler" aria-hidden="true"></i> Medida das
                                              √°reas</strong>
                                          </h6>
                                          <div class="row mt-3" style="margin-left: -50px;">
                                            <div class="col-md-12">
                                              <h6 style="font-size: 12px;">
                                                <strong>Total: {{ item.medidas.area_total }} m¬≤</strong>
                                              </h6>
                                              <h6 style="font-size: 12px;">
                                                <strong>Construida: {{ item.medidas.area_contruida }} m¬≤</strong>
                                              </h6>
                                              <h6 style="font-size: 12px;">
                                                <strong>Privativa: {{ item.medidas.area_privativa }} m¬≤</strong>
                                              </h6>
                                              <h6 style="font-size: 12px;">
                                                <strong>Pre√ßo m¬≤: R$ {{ item.medidas.media_metro_quadrado }}</strong>
                                              </h6>
                                            </div>
                                          </div>
                                        </div>

                                        <hr class="mt-3">

                                        <div class="col-md-7">
                                          <h6 style="font-size: 12px;"><strong><i class="fa fa-check-square"
                                                aria-hidden="true"></i> Caracte√≠stica do
                                              im√≥vel</strong>
                                          </h6>
                                          <div class="row mt-3">
                                            <div class="col-md-2" v-for="dado in item.caracteristicas">
                                              <h6>
                                                <span><i class="fa fa-check"></i> <small>{{
                                                  dado.detalhesCaracteristica.nome_caracteristica }}</small></span>
                                              </h6>
                                            </div>
                                          </div>
                                          <hr>
                                        </div>

                                        <div class="col-md-5">
                                          <h6 style="font-size: 12px;"><strong><i class="fa fa-edit"
                                                aria-hidden="true"></i>
                                              Detalhes do
                                              im√≥vel</strong>
                                          </h6>
                                          <div class="row mt-3">
                                            <div class="col-md-2">
                                              <div class="avatar-null img-fluid rounded me-1" alt="Avatar">{{ iniciais
                                                }}</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                              <h6 style="font-size: 12px;">
                                                <strong>Respons√°vel</strong>
                                              </h6>
                                              <h6 style="font-size: 12px;">
                                                {{ nome }} {{ sobrenome }}
                                              </h6>
                                            </div>
                                            <div class="col-md-1">
                                              <div style="border-left: 1px solid #0001; height: 40px; ">
                                              </div>
                                            </div>
                                            <div class="col-md-3" style="margin-top: -10px;">
                                              <img :src="item.qrcode[0].qrcode" width="50" alt="">
                                            </div>
                                          </div>

                                        </div>

                                        <div class="col-md-7" style="margin-top: 4%;">
                                          <h6 style="font-size: 12px;">
                                            <strong><i class="fa fa-check-square" aria-hidden="true"></i>
                                              Proximidades</strong>
                                          </h6>
                                          <div class="row mt-3">
                                            <div class="col-md-2" v-for="dado in item.proximidades">
                                              <h6>
                                                <span><i class="fa fa-check"></i><small>
                                                    {{ dado.detalhesProximidade.nome_proximidade }}</small> </span>
                                              </h6>
                                            </div>
                                          </div>
                                          <hr>
                                        </div>

                                        <div class="col-md-7" style="margin-top: 2%;">
                                          <h6 style="font-size: 12px;">
                                            <strong><i class="fa fa-edit" aria-hidden="true"></i> Descri√ß√£o do
                                              Im√≥vel</strong>
                                          </h6>
                                          <div class="row mt-3">
                                            {{ item.descricao.apresentacao }}
                                          </div>
                                        </div>

                                        <div class="col-md-5" style="margin-top: -150px;">

                                          <table class="table">
                                            <tbody>
                                              <tr>
                                                <td style="background-color: #0001;">
                                                  <strong><small>Ano da
                                                      constru√ß√£o:</small></strong>
                                                </td>
                                                <td style="background-color: #0001;">
                                                  <small>{{ item.info.ano_construcao }}</small>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td><strong><small>Incorpora√ß√£o:</small></strong></td>
                                                <td><small>{{ item.info.incorporacao }}</small></td>
                                              </tr>
                                              <tr>
                                                <td style="background-color: #0001;">
                                                  <strong><small>Situa√ß√£o do Im√≥vel:</small></strong>
                                                </td>
                                                <td style="background-color: #0001;">
                                                  <small>{{ item.info.situacao_imovel }}</small>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td><strong><small>Esquina:</small></strong>
                                                </td>
                                                <td><small>{{ item.info.esquina }}</small></td>
                                              </tr>
                                              <tr>
                                                <td style="background-color: #0001;">
                                                  <strong><small>Tem
                                                      Financiamento:</small></strong>
                                                </td>
                                                <td style="background-color: #0001;">
                                                  <small>{{ item.preco.financiado }}</small>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td><strong><small>Aceita
                                                      financiamento:</small></strong>
                                                </td>
                                                <td><small>{{ item.preco.aceita_financiamento }}</small></td>
                                              </tr>
                                              <tr>
                                                <td style="background-color: #0001;">
                                                  <strong><small>Minha Casa Minha
                                                      Vida:</small></strong>
                                                </td>
                                                <td style="background-color: #0001;">
                                                  <small>{{ item.preco.minhacasa_minhavida }}</small>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td><strong><small>Aceita
                                                      permuta:</small></strong></td>
                                                <td><small>{{ item.preco.aceita_permuta }}</small></td>
                                              </tr>

                                              <div class="col-md-12 mt-3">

                                              </div>

                                            </tbody>
                                          </table>

                                          <div class="mt-3">
                                            <h6 style="font-size: 12px;">
                                              <strong>Qualidade do an√∫ncio <span class="badge text-bg-success">{{
                                                qualidadeProgress }}% </span>
                                                &nbsp;</strong>
                                              <small> {{ msgQualidade }} <i v-for="star in estrelas" :key="star"
                                                  class="text-warning fa fa-star"></i></small>
                                            </h6>
                                            <div class="progress" role="progressbar" aria-label="Success example"
                                              :aria-valuenow="qualidadeProgress" aria-valuemin="0" aria-valuemax="100">
                                              <div class="progress-bar bg-success"
                                                :style="{ width: qualidadeProgress + '%' }"></div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="tab-pane fade show" id="nav-documentos" role="tabpanel"
                                    aria-labelledby="nav-documentos-tab" tabindex="0">
                                    <div class="container">
                                      <div class="row mt-3">
                                        <div class="col-md-8">
                                          <h6 style="font-size: 15px;"><strong><i class="fa fa-link"
                                                aria-hidden="true"></i> Links </strong>
                                          </h6>
                                          <div class="row mt-3">
                                            <div class="col-md-3">
                                              <h6 style="font-size: 12px;">
                                                <strong>Drive: <a :href="item.complemento.link_drive" target="_blank">{{
                                                  item.complemento.link_drive }}</a></strong>
                                              </h6>

                                              <h6 style="font-size: 12px;">
                                                <strong>YouTube: <a :href="item.complemento.link_youtube"
                                                    target="_blank">{{ item.complemento.link_youtube }}</a></strong>
                                              </h6>

                                              <h6 style="font-size: 12px;">
                                                <strong>Apresenta√ß√£o: <a :href="item.complemento.link_apresentacao"
                                                    target="_blank">{{ item.complemento.link_apresentacao
                                                    }}</a></strong>
                                              </h6>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <div class="tab-pane fade show" id="nav-comentario" role="tabpanel"
                                    aria-labelledby="nav-comentario-tab" tabindex="0">
                                    <div class="container">
                                      <div class="row mt-3">
                                        <div class="col-md-12">
                                          <h6 style="font-size: 15px;"><strong><i class="fa fa-list"
                                                aria-hidden="true"></i> Fa√ßa aqui as anota√ß√µes sobre este im√≥vel
                                            </strong>
                                          </h6>
                                          <div class="row mt-3">
                                            <div class="col-md-12">
                                              <div class="form-floating">
                                                <textarea class="form-control" placeholder="Leave a comment here"
                                                  id="floatingTextarea2" style="height: 300px"></textarea>
                                                <label for="floatingTextarea2"></label>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                          <button class="btn btn-success me-md-2"
                                            @click="handledComentario(item.id_imovel)" type="button">Salvar
                                            anota√ß√£o</button>
                                        </div>

                                      </div>
                                    </div>
                                  </div>

                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="d-grid mt-3 mb-3 gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-dark btn-sm" @click="previousPageImovel()"
                          :disabled="currentPageImovel <= 1"> Anterior
                        </button>
                        <button class=" btn btn-dark btn-sm" style="margin-right: 3% !important;"
                          @click="nextPageImovel()" :disabled="currentPageImovel >= totalPagesImoveis">
                          Proximo
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-xl-7 col-xxl-7">
                  <div class="card flex-fill w-100">
                    <div class="card-header">
                      <h5 class="card-title mb-0"><i class="fa fa-map-marker"></i> Localize seus im√≥veis</h5>
                    </div>
                    <div class="card-body py-3">


                    </div>
                  </div>
                </div>


                <div class="col-xl-12 col-xxl-12">
                  <div class="card flex-fill w-100">
                    <div class="card-header">
                      <h5 class="card-title mb-0"><i class="fa fa-ruler"></i> M√©dia do m2 <button
                          style="float: inline-end;" type="button" class="btn btn-warning btn-sm"><i
                            class="fa fa-filter"></i> Reiniciar filtros</button></h5>
                    </div>
                    <div class="card-body py-3">
                      <div class="chart chart-sm">

                        <div class="row">
                          <div class="col-1 mb-3">
                            <label for="tipoNegocio" class="form-label">UF <small><i
                                  class="fa fa-filter"></i></small></label>
                            <select class="form-select" v-model="selectedUf" @change="filtrarImoveis">
                              <option value="">Escolha</option>
                              <option v-for="uf in ufs" :key="uf" :value="uf">{{ uf }}</option>
                            </select>
                          </div>
                          <div class="col-1">
                            <label for="cidade" class="form-label">Cidade <small><i
                                  class="fa fa-filter"></i></small></label>
                            <select class="form-select" v-model="selectedCidade" @change="filtrarImoveis">
                              <option value="">Escolha</option>
                              <option v-for="cidade in cidades" :key="cidade" :value="cidade">{{ cidade }}</option>
                            </select>
                          </div>
                          <div class="col-1">
                            <label for="bairro" class="form-label">Bairro <small><i
                                  class="fa fa-filter"></i></small></label>
                            <select class="form-select" v-model="selectedBairro" @change="filtrarImoveis">
                              <option value="">Selecione</option>
                              <option v-for="bairro in bairros" :key="bairro" :value="bairro">{{ bairro }}</option>
                            </select>
                          </div>
                          <div class="col-2">
                            <label for="tipoNegocio" class="form-label">Tipo de neg√≥cio <small><i
                                  class="fa fa-filter"></i></small></label>
                            <select class="form-select" v-model="selectedTipoNegocio" @change="filtrarImoveis">
                              <option value="">Escolha</option>
                              <option value="Venda">Venda</option>
                              <option value="Aluguel">Aluguel</option>
                            </select>
                          </div>
                          <div class="col-2">
                            <label for="status" class="form-label">Status <small><i
                                  class="fa fa-filter"></i></small></label>
                            <select class="form-select" v-model="selectedStatus" @change="filtrarImoveis">
                              <option value="">Escolha</option>
                              <option value="Sim">Publicado</option>
                              <option value="N√£o">N√£o publicado</option>
                            </select>
                          </div>
                          <div class="col-2">
                            <label for="tipoImovel" class="form-label">Tipo do im√≥vel <small><i
                                  class="fa fa-filter"></i></small></label>
                            <select class="form-select" v-model="selectedTipoImovel" @change="filtrarImoveis">
                              <option value="">Selecione</option>
                              <option value="Casa">Casa</option>
                              <option value="Apartamento">Apartamento</option>
                              <option value="Flat">Flat</option>
                              <option value="Terreno">Terreno</option>
                              <option value="S√≠tio">S√≠tio</option>
                              <option value="Haras">Haras</option>
                              <option value="Kitnet">Kitnet</option>
                              <option value="Fazenda">Fazenda</option>
                              <option value="Galp√£o">Galp√£o</option>
                              <option value="Sala Comercial">Sala Comercial</option>
                            </select>
                          </div>
                          <div class="col-2">
                            <label for="proximoMar" class="form-label">Proximo do Mar? <small><i
                                  class="fa fa-filter"></i></small></label>
                            <select class="form-select" v-model="selectedProximoMar" @change="filtrarImoveis">
                              <option value="">Selecione</option>
                              <option value="Vista para o mar">Vista para o mar</option>
                              <option value="Frente para o mar">Frente para o mar</option>
                              <option value="Quadra do mar">Quadra do mar</option>
                              <option value="Proximo ao mar">Proximo ao mar</option>
                              <option value="N√£o">N√£o</option>
                            </select>
                          </div>
                          <div class="col-1">
                            <label for="quartos" class="form-label">Quartos <small><i
                                  class="fa fa-filter"></i></small></label>
                            <input style="height: 34px;" type="number" class="form-control" v-model="selectedQuartos"
                              @input="filtrarImoveis" placeholder="00">
                          </div>
                          <canvas id="myMetroQuadrado" v-if="filteredImoveis.length"></canvas>
                          <div v-if="!filteredImoveis.length">
                            <div class="alert alert-primary mt-3" role="alert">
                              üòî Desculpe, n√£o achamos nenhum im√≥vel com essas caracter√≠sticas.
                            </div>
                            <div>
                              <img style="margin-left: auto; margin-right: auto; display: block;"
                                src="../../../assets/images/filterImage.svg" alt="">
                            </div>
                          </div>


                        </div>

                      </div>

                    </div>
                  </div>
                </div>

                <div class="col-xl-6 col-xxl-6">
                  <div class="card flex-fill w-100">
                    <div class="card-header">
                      <h5 class="card-title mb-0">Imoveis publicados X Im√≥veis aguardando</h5>
                    </div>
                    <div class="card-body py-3">
                      <div class="chart chart-sm">
                        <canvas id="myChartPublicado"></canvas>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-xl-6 col-xxl-6">
                  <div class="card flex-fill w-100">
                    <div class="card-header">
                      <h5 class="card-title mb-0">Aluguel x Venda</h5>
                    </div>
                    <div class="card-body py-3">
                      <div class="chart chart-sm">
                        <canvas id="myChartTipo"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <Footer />
    </div>
  </div>
</template>
<script>
import Sidebar from '../../components/sidebar/index.vue'
import Navbar from '../../components/navbar/index.vue'
import Footer from '../../components/footer/index.vue'
import api from '../../../service/api/index'
import { jwtDecode } from "jwt-decode";
import axios from 'axios';
import 'https://cdn.jsdelivr.net/npm/chart.js'

export default {
  name: 'MainView',
  props: {
    cep: String,
  },
  data() {
    return {
      token: localStorage.getItem('token'),
      perfil: 0,
      capa: 0,
      imovel: 0,
      publicacao: 0,
      progressView: false,
      iniciais: '',
      nome: '',
      sobrenome: '',
      id_user: '',
      myImoveis: [],
      allImoveis: [],
      qualidade: '',
      aluguel: 0,
      venda: 0,
      aguardando: 0,
      publicado: 0,
      qualidadeProgress: 0,
      msgQualidade: '',
      estrelas: 0,
      porcentagemQualidade: 0,
      totalImovel: '',


      filteredImoveis: [],
      ufs: [],
      cidades: [],
      bairros: [],
      selectedUf: '',
      selectedCidade: '',
      selectedBairro: '',
      selectedTipoNegocio: '',
      selectedStatus: '',
      selectedTipoImovel: '',
      selectedProximoMar: '',
      selectedQuartos: '',
      chart: null,


      mediaValorMetroQuadrado: 0,
      chartInstance: null,

      currentPageImovel: 1,
      perPageImovel: 2,
      searchImovel: '',

      totalCondominios: 0,



    }
  },
  components: {
    Sidebar,
    Navbar,
    Footer,
  },

  watch: {
    selectedUf(newVal, oldVal) {
      if (newVal !== oldVal) {
        this.selectedCidade = "";
        this.selectedBairro = "";
        this.atualizarOpcoesFiltro();
      }
    }
  },

  mounted() {
    let token = this.token;
    let decode = jwtDecode(token);
    let id_user = decode.id_user;
    this.nome = decode.nome
    this.sobrenome = decode.sobrenome
    this.id_user = id_user
    const iniciais = this.nome.charAt(0) + this.sobrenome.charAt(0);
    this.iniciais = iniciais

    this.ferchProgress();
    this.fetchMyImoveis();
    this.fetchAllImoveis();
    this.fetchMyCondominios();
  },

  methods: {

    formatCurrency(value) {
      if (typeof value !== "number") {
        value = parseFloat(value);
      }
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    },
    formatarData(dataString) {
      if (!dataString) return '';
      const data = new Date(dataString);
      return data.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    },
    fetchMyImoveis() {
      let id_user = this.id_user;

      api.listmyImoveis(id_user).then(res => {
        this.myImoveis = res.data;
        this.totalImovel = this.myImoveis.length;
        this.renderChart(res.data);

        this.avaliarQualidadeCadastro(this.myImoveis);

        const imovelVenda = res.data.filter(
          (item) => item.preco.tipo_negocio === 'Venda'
        );
        this.venda = imovelVenda.length;

        const imovelAluguel = res.data.filter(
          (dados) => dados.preco.tipo_negocio === 'Aluguel'
        );
        this.aluguel = imovelAluguel.length;

        const ctx = document.getElementById("myChartTipo");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Aluguel", "Venda"],
            datasets: [
              {
                label: "My First Dataset",
                data: [this.aluguel, this.venda],
                backgroundColor: ["rgb(255, 99, 132)", "rgb(54, 162, 235)"],
                hoverOffset: 4,
              },
            ],
          },
        });

        const imovelPublicado = res.data.filter(
          (item) => item.publicacao.mostrar_imovel_publi === 'Sim'
        );
        this.publicado = imovelPublicado.length;

        const imovelAguardando = res.data.filter(
          (dados) => dados.publicacao.mostrar_imovel_publi === 'N√£o'
        );
        this.aguardando = imovelAguardando.length;

        const ctxx = document.getElementById("myChartPublicado");
        new Chart(ctxx, {
          type: "pie",
          data: {
            labels: ["Publicado", "Aguardando"],
            datasets: [
              {
                label: "My First Dataset",
                data: [this.publicado, this.aguardando],
                backgroundColor: ["#41A9CD  ", "#A7AEAC"],
                hoverOffset: 4,
              },
            ],
          },
        });

        let latitude
        let longitude

        const map = L.map('map').setView([latitude, longitude], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        res.data.forEach(imovel => {
          let cep = imovel.localizacao.cep;
          const apiKey = '1f64d822c44341f38692b2b37ec70e64';

          axios.get(`https://api.opencagedata.com/geocode/v1/json?q=${cep}+Brazil&key=${apiKey}`)
            .then(response => {
              const data = response.data;
              if (data && data.results && data.results.length > 0) {
                const location = data.results[0].geometry;

                latitude = location.lat;
                longitude = location.lng;


                L.marker([latitude, longitude]).addTo(map)
                  .bindPopup(`Latitude: ${location.lat} Longitude: ${location.lng}`).openPopup();

              }
            })
            .catch(error => console.error('Erro ao buscar coordenadas do CEP:', error));
        });

      })
    },
    atualizarGrafico() {
      const ctx = document.getElementById('myMetroQuadrado');
      if (ctx) {
        if (this.chart) this.chart.destroy();

        if (!this.filteredImoveis.length) {
          // Mostrar mensagem e imagem aqui
          return;
        }

        const labels = this.filteredImoveis.map(imovel => imovel.localizacao.bairro);
        const data = this.filteredImoveis.map(imovel => parseFloat(imovel.medidas.media_metro_quadrado));

        this.chart = new Chart(ctx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'M√©dia do m¬≤',
              data: data,
              borderWidth: 1,
              backgroundColor: "rgba(81, 229, 255, 0.2)",
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    },
    ferchProgress() {
      let id_user = this.id_user;

      api.progress(id_user).then(res => {

        this.perfil = res.data.perfil;
        this.capa = res.data.logo_capa;
        this.imovel = res.data.imovel;
        this.publicacao = res.data.publicacao;

        if (this.perfil == 1 && this.capa == 1 && this.imovel == 1 && this.publicacao == 1) {
          this.progressView = false;
        } else {
          this.progressView = true;
        }

      })
    },
    avaliarQualidadeCadastro(imoveis) {
      imoveis.forEach(imovel => {
        let totalCampos = 0;
        let camposNulos = 0;

        const analisarObjeto = (obj) => {
          Object.values(obj).forEach(val => {
            if (val && typeof val === 'object' && !Array.isArray(val)) {
              analisarObjeto(val);
            } else {
              totalCampos++;
              if (val === null || val === '') {
                camposNulos++;
              }
            }
          });
        };

        analisarObjeto(imovel);

        const pontuacaoMaxima = 10;
        const pontuacao = Math.round((totalCampos - camposNulos) / totalCampos * pontuacaoMaxima);
        const porcentagem = Math.round((totalCampos - camposNulos) / totalCampos * 100); // Calcula a porcentagem

        imovel.pontuacaoQualidade = `${pontuacao}/10`;
        imovel.porcentagemQualidade = porcentagem;
        this.qualidade = imovel.pontuacaoQualidade;


        if (porcentagem == 100) {
          this.estrelas = 5;
          this.msgQualidade = 'Excelente';
        } else if (porcentagem >= 80) {
          this.estrelas = 4;
          this.msgQualidade = 'Muito Bom';
        } else if (porcentagem >= 60) {
          this.estrelas = 3;
          this.msgQualidade = 'Bom';
        } else if (porcentagem >= 40) {
          this.estrelas = 2;
          this.msgQualidade = 'Regular';
        } else if (porcentagem >= 20) {
          this.estrelas = 1;
          this.msgQualidade = 'Ruim';
        } else {
          this.estrelas = 0;
          this.msgQualidade = 'P√©ssimo';
        }

        this.qualidadeProgress = porcentagem;


      });

      return imoveis;
    },
    handledComentario(id) {
      let id_imovel = id;

      api.comentarioImovel(id_imovel).then(res => {
        this.comentario = res.data;
      })
    },
    handledDelete(id) {

      let id_imovel = id;

      api.deleteImovel(id_imovel).then(res => {
        this.fetchMyImoveis();
      })

    },
    fetchMyCondominios() {
      let id_user = this.id_user
      api.listcondominio(id_user).then((res) => {
        this.totalCondominios = res.data.response.length;
      })
    },
    fetchAllImoveis() {
      api.listallImoveis().then(res => {
        this.allImoveis = res.data;
        this.ufs = [...new Set(this.allImoveis.map(imovel => imovel.localizacao.estado))];
        this.atualizarOpcoesFiltro();
        this.filtrarImoveis();
      })
    },
    atualizarOpcoesFiltro() {
      if (this.selectedUf) {
        const imoveisFiltrados = this.allImoveis.filter(imovel => imovel.localizacao.estado === this.selectedUf);
        this.cidades = [...new Set(imoveisFiltrados.map(imovel => imovel.localizacao.cidade))];
        this.bairros = [...new Set(imoveisFiltrados.map(imovel => imovel.localizacao.bairro))];
      } else {
        this.cidades = [...new Set(this.allImoveis.map(imovel => imovel.localizacao.cidade))];
        this.bairros = [...new Set(this.allImoveis.map(imovel => imovel.localizacao.bairro))];
      }
    },

    filtrarImoveis() {
      this.filteredImoveis = this.allImoveis.filter(imovel => {
        return (
          (!this.selectedUf || imovel.localizacao.estado === this.selectedUf) &&
          (!this.selectedCidade || imovel.localizacao.cidade === this.selectedCidade) &&
          (!this.selectedBairro || imovel.localizacao.bairro === this.selectedBairro) &&
          (!this.selectedTipoNegocio || imovel.preco.tipo_negocio === this.selectedTipoNegocio) &&
          (!this.selectedStatus || imovel.publicacao.mostrar_imovel_publi === this.selectedStatus) &&
          (!this.selectedTipoImovel || imovel.info.tipo === this.selectedTipoImovel) &&
          (!this.selectedProximoMar || imovel.info.proximo_mar === this.selectedProximoMar) &&
          (!this.selectedQuartos || imovel.comodos.dormitorio == this.selectedQuartos)
        );
      });

      this.atualizarOpcoesFiltro();
      this.atualizarGrafico();
    },

    previousPageImovel() {
      if (this.currentPageImovel > 1) {
        this.currentPageImovel -= 1
      }
    },
    nextPageImovel() {
      if (this.currentPageImovel < this.totalPagesImoveis) {
        this.currentPageImovel += 1
      }
    },


  },

  computed: {
    imoveisOnCurrentPage() {
      const startIndex = (this.currentPageImovel - 1) * this.perPageImovel
      const endIndex = startIndex + this.perPageImovel
      return this.myImoveis
        .filter((imovel) => {
          return imovel.descricao.titulo
            .toLowerCase()
            .includes(this.searchImovel.toLowerCase())
        })
        .slice(startIndex, endIndex)
    },
    totalPagesImoveis() {
      return Math.ceil(
        this.myImoveis.filter((imovel) => {
          this.currentPageConcept = 1
          return imovel.descricao.titulo
            .toLowerCase()
            .includes(this.searchImovel.toLowerCase())
        }).length / this.perPageImovel,
      )
    },
  }

}
</script>